#!/bin/bash
# Description: display notificatinos on mpd event with album cover
# Dependencies: ffmpeg, mpd, mpc
# Shell: Bash
set -eu -o pipefail

cover="/tmp/mpd_cover.png"
music_library="$HOME/Music"

trap 'rm "$cover"' TERM INT HUP EXIT

# wait for mpd to fire up
sleep 2

while true;
do
	mpc idle player > /dev/null

	# update statusbar
	kill -RTMIN+1 "$(cat ~/.cache/pidofbar)"

	if ! mpc | grep "playing" > /dev/null; then
		continue
	fi

	if ! ffmpeg -loglevel -8 -y -i "$(mpc --format "$music_library"/%file% | head -n 1)" "$cover"; then
		notify-send -i apple-music "Now Playing" "$(mpc current)"
		continue
	fi

	notify-send -i "$cover" "Now Playing" "$(mpc current)"
done
